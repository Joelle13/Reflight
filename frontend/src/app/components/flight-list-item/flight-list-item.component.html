<div *ngIf="!flight">
  <p>No flights available.</p>
</div>

<div class="container d-flex justify-content-center" *ngIf="flight">
  <div class="card mb-3 custom-card-size mt-3">
    <div class="row g-0">
      <div class="col-md-4">
        <img src="" class="img-fluid rounded-start" alt="...">
      </div>
      <div class="col-md-8">
        <div class="card-body">
          <!-- Header avec numéro de vol et compagnie -->
          <div class="flight-header">
            <h3>{{flight.id}}</h3>
            <div class="airline-info">
              <h3>{{flight.airline.name}}</h3>
              <img src="{{flight.airline.url}}" alt="{{flight.airline.name}}">
            </div>
          </div>

          <!-- Informations de vol en grille -->
          <div class="flight-info-grid">
            <div class="flight-info-item">
              <label>Départ</label>
              <span>{{flight.departureAirport}}</span>
            </div>
            <div class="flight-info-item">
              <label>Arrivée</label>
              <span>{{flight.arrivalAirport}}</span>
            </div>
            <div class="flight-info-item">
              <label>Heure de départ</label>
              <span>{{flight.departureTime}}</span>
            </div>
            <div class="flight-info-item">
              <label>Date de départ</label>
              <span>{{flight.departureDate| date:'dd/MM/yyyy'}}</span>
            </div>
            <div class="flight-info-item">
              <label>Date d'arrivée</label>
              <span>{{flight.arrivalDate | date:'dd/MM/yyyy'}}</span>
            </div>
            <div class="flight-info-item">
              <label>Heure d'arrivée</label>
              <span>{{flight.arrivalTime}}</span>
            </div>
          </div>

          <!-- Footer -->
          <div class="d-flex justify-content-between">
            <p class="card-text">Nombre d'avis : {{reviewCount}}</p>
            <button class="btn btn-primary btn-custom-1 me-2" type="button" (click)="openReviewModal()">Rédiger un avis</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal création d'avis -->
<div class="modal-overlay" *ngIf="showReviewModal" (click)="closeReviewModal()">
  <div class="modal-content modal-review" (click)="$event.stopPropagation()">

    <!-- En-tête de la modal -->
    <div class="modal-header">
      <h3>✍️ Rédiger un avis</h3>
      <button class="btn-close" (click)="closeReviewModal()">
        <i class="fa fa-times"></i>
      </button>
    </div>

    <!-- Informations du vol -->
    <div class="modal-flight-summary">
      <div class="flight-summary-header">
        <i class="fa fa-plane"></i>
        <span>Votre vol</span>
      </div>
      <div class="flight-summary-content">
        <div class="flight-route">
          <div class="airport-box">
            <span class="airport-code">{{flight.departureAirport}}</span>
            <span class="airport-label">Départ</span>
          </div>
          <div class="flight-arrow">
            <i class="fa fa-plane"></i>
          </div>
          <div class="airport-box">
            <span class="airport-code">{{flight.arrivalAirport}}</span>
            <span class="airport-label">Arrivée</span>
          </div>
        </div>
        <div class="flight-details">
          <div class="flight-detail-item">
            <i class="fa fa-hashtag"></i>
            <span>Vol {{flight.id}}</span>
          </div>
          <div class="flight-detail-item">
            <i class="fa fa-building"></i>
            <span>{{flight.airline.name}}</span>
          </div>
          <div class="flight-detail-item">
            <i class="fa fa-calendar"></i>
            <span>{{flight.departureDate | date:'dd/MM/yyyy'}}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Formulaire -->
    <form [formGroup]="addReview" (ngSubmit)="submitReview()" class="modal-body">

      <!-- Informations utilisateur -->
      <div class="form-section">
        <h4 class="section-title">Vos informations</h4>

        <div class="form-row">
          <div class="form-group">
            <label>Prénom <span class="required">*</span></label>
            <input
              type="text"
              class="form-control"
              formControlName="firstName"
              placeholder="Jean"
              [class.is-invalid]="firstName.invalid && firstName.touched"
              [class.is-valid]="firstName.valid && firstName.touched">
            <div *ngIf="firstName?.invalid && firstName.touched" class="invalid-feedback">
              <div *ngIf="firstName?.errors?.['required']">Le prénom est requis</div>
            </div>
          </div>

          <div class="form-group">
            <label>Nom <span class="required">*</span></label>
            <input
              type="text"
              class="form-control"
              formControlName="lastName"
              placeholder="Dupont"
              [class.is-invalid]="lastName.invalid && lastName.touched"
              [class.is-valid]="lastName.valid && lastName.touched">
            <div *ngIf="lastName?.invalid && lastName.touched" class="invalid-feedback">
              <div *ngIf="lastName?.errors?.['required']">Le nom est requis</div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Email <span class="required">*</span></label>
          <input
            type="email"
            class="form-control"
            formControlName="email"
            placeholder="jean.dupont@exemple.com"
            [class.is-invalid]="email.invalid && email.touched"
            [class.is-valid]="email.valid && email.touched">
          <div *ngIf="email?.invalid && email.touched" class="invalid-feedback">
            <div *ngIf="email?.errors?.['required']">L'email est requis</div>
            <div *ngIf="email?.errors?.['email']">L'email n'est pas valide</div>
          </div>
        </div>
      </div>

      <!-- Note avec étoiles -->
      <div class="form-section">
        <h4 class="section-title">Votre note</h4>
        <div class="rating-selector">
          <div class="stars-container">
            <i class="fa fa-star star-clickable"
               *ngFor="let star of [1,2,3,4,5]; let i = index"
               [class.filled]="star <= selectedRating"
               [class.hovered]="star <= hoveredRating"
               (click)="setRating(star)"
               (mouseenter)="hoveredRating = star"
               (mouseleave)="hoveredRating = 0"></i>
          </div>
          <span class="rating-text" *ngIf="selectedRating > 0">
            {{getRatingLabel(selectedRating)}}
          </span>
          <span class="rating-text text-muted" *ngIf="selectedRating === 0">
            Cliquez sur les étoiles pour noter
          </span>
        </div>
        <div *ngIf="rating.invalid && rating.touched" class="invalid-feedback d-block">
          <div *ngIf="rating?.errors?.['required']">Veuillez attribuer une note</div>
        </div>
      </div>

      <!-- Commentaire -->
      <div class="form-section">
        <h4 class="section-title">Votre commentaire</h4>
        <div class="form-group">
          <label>Partagez votre expérience <span class="required">*</span></label>
          <textarea
            class="form-control"
            formControlName="comments"
            rows="6"
            [class.is-invalid]="comments.invalid && comments.touched"
            [class.is-valid]="comments.valid && comments.touched"
            placeholder="Décrivez votre expérience de vol : confort, service, ponctualité, etc."
            maxlength="1000"></textarea>
          <div class="char-counter">
            {{comments.value.length || 0}} / 1000 caractères
          </div>
          <div *ngIf="comments?.invalid && comments.touched" class="invalid-feedback">
            <div *ngIf="comments?.errors?.['required']">Le commentaire est requis</div>
            <div *ngIf="comments?.errors?.['minlength']">Le commentaire doit contenir au moins 10 caractères</div>
          </div>
        </div>
      </div>

      <!-- Boutons d'action -->
      <div class="modal-footer">
        <button type="button" class="btn btn-cancel" (click)="closeReviewModal()">
          Annuler
        </button>
        <button type="submit" class="btn btn-submit" [disabled]="addReview.invalid">
          <i class="fa fa-paper-plane"></i> Publier mon avis
        </button>
      </div>
    </form>
  </div>
</div>
